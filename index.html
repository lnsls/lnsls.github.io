<!doctype html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <title>考试展示2.0梁耐松</title>
  <style>
    body {
      font-family: "Microsoft YaHei", "微软雅黑", SimHei, "黑体";
    }

    .divZhanshi {
      margin-left: 24px;
    }

    .divZsNeirong {
      font-size: 9vw;
      font-weight: bold;
      color: #000;
    }

    #suggestions {
      background: #FFFFCC;
      list-style: none;
      padding: 0;
      margin: 0;
      position: absolute;
      width: 360px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1;
      display: none;
    }

    #suggestions li {
      padding: 5px;
      cursor: pointer;
      font-size: 20px;
    }

    button {
      cursor: pointer;
    }

    #helpModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .help-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      text-align: left;
      font-size: 16px;
    }

    .help-content p {
      white-space: pre-line;
      line-height: 1.5em;
    }

    .help-content div {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div style="font-size:12px;opacity:.96;padding-bottom:5px;border-bottom:1px solid #ccc">
    科目:
    <input id="inputKemu" size="20">
    <ul id="suggestions"></ul>
    <input id="inputChangci" size="20">
    <input id="inputYeshu" size="20" value="考试码 试卷共2页">
    <button onclick="clickUpdate()">修改</button> |
    <button onclick="clickHuanchang()">换场</button>
    <button onclick="clickDa()">放大</button>
    <button onclick="clickXiao()">缩小</button>
    <button id="btBofang" onclick="togglePlay()">播放</button>
    <button onclick="showHelp()">帮助</button>
    <button onclick="enterFullscreen()">全屏</button>
  </div>

  <div class="divZhanshi">
    <div id="divKemu" class="divZsNeirong">科目: </div>
    <div id="divChangci" class="divZsNeirong"></div>
    <div id="divTime" class="divZsNeirong">现在时间: 加载中..</div>
    <div id="divYeshu" class="divZsNeirong"></div>
  </div>

  <button id="btJiaojuan" onclick="playSubmit()" style="opacity:0;">交卷</button>

  <!-- 帮助模态框 -->
  <div id="helpModal">
    <div class="help-content">
      <p>请使用全屏！
        全屏时防止系统休眠；若依旧休眠，请更换浏览器或调整电脑电源设置；
        网络时间获取失败将使用电脑时间，若时间错误请修改电脑时间后重新打开。</p>
      <div>
        <button onclick="closeHelp()">我知道了</button>
      </div>
    </div>
  </div>

  <script>
    const suggestions = [
      "统计学基础",
      "C语言程序设计",
      "基础泰语/国际商法",
      "商务文案撰写"
    ];
    const changCiLb = ["考试时间: 8:40-10:10", "考试时间: 10:20-11:50", "考试时间: 14:30-15:50", "考试时间: 16:00-17:20"];
    let ccIndex = 0, timestamp = Math.floor(Date.now() / 1000), wakeLock = null;
    const el = id => document.getElementById(id); // 简化 document.getElementById 写法

    // 初始化页面
    window.onload = () => {
      fetchTimestamp(); // 获取时间
      autoSetChangci(); // 自动设定场次
      updateDisplay(); // 初始数据显示
      setInterval(updateTime, 1000); // 每秒更新时间
    };

    // 页面恢复前台时重新获取网络时间，避免后台时间暂停

    let lastHiddenTime = null;
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        lastHiddenTime = Date.now();
      } else if (document.visibilityState === 'visible') {
        const now = Date.now();
        const diff = Math.floor((now - (lastHiddenTime || now)) / 1000);
        timestamp += diff;
        fetchTimestamp(); // 前台时尝试重新同步网络时间
      }
    });

    // 从网络获取标准时间戳（失败时使用本地时间）
    async function fetchTimestamp() {
      try {
        const res = await fetch('https://worldtimeapi.org/api/ip');
        const data = await res.json();
        timestamp = data.unixtime;
      } catch {
        timestamp = Math.floor(Date.now() / 1000);
      }
    }

    // 根据当前时间设定考试场次
    function autoSetChangci() {
      const now = new Date(), h = now.getHours(), m = now.getMinutes();
      let val = changCiLb[0];
      if (h >= 10 && h < 12) val = changCiLb[1];
      else if (h === 14 || (h === 15 && m <= 40)) val = changCiLb[2];
      else if ((h === 15 && m > 40) || h >= 16) val = changCiLb[3];
      el("inputChangci").value = el("divChangci").innerText = val;
    }

    // 每秒更新时间戳并更新界面显示
    function updateTime() {
      timestamp++;
      el("divTime").innerText = "现在时间: " + new Date(timestamp * 1000).toTimeString().split(' ')[0];
    }

    // 点击“修改”按钮：更新科目、页数、考试时间
    function clickUpdate() {
      el("divKemu").innerText = "科目: " + el("inputKemu").value;
      el("divYeshu").innerText = el("inputYeshu").value;
      el("divChangci").innerText = el("inputChangci").value;
    }

    // 点击“换场”按钮：循环切换考试时间
    function clickHuanchang() {
      const val = changCiLb[ccIndex++];
      if (ccIndex >= changCiLb.length) ccIndex = 0;
      el("inputChangci").value = el("divChangci").innerText = val;
    }

    // 点击放大字体按钮
    function clickDa() { adjustFontSize(10); }

    // 点击缩小字体按钮
    function clickXiao() { adjustFontSize(-10); }

    // 调整所有展示区文字大小
    function adjustFontSize(delta) {
      document.querySelectorAll('.divZsNeirong').forEach(div => {
        const f = parseFloat(getComputedStyle(div).fontSize);
        div.style.fontSize = (f + delta) + 'px';
      });
    }

    // 显示帮助模态框
    function showHelp() {
      el("helpModal").style.display = "flex";
    }

    // 关闭帮助模态框
    function closeHelp() {
      el("helpModal").style.display = "none";
    }

    // 进入全屏并尝试防止系统休眠
    function enterFullscreen() {
      const docEl = document.documentElement;
      const f = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
      if (f) f.call(docEl);
      if (navigator.wakeLock?.request) requestWakeLock();
    }

    // 请求唤醒锁，避免自动休眠（部分浏览器支持）
    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => wakeLock = null);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible' && !wakeLock) requestWakeLock();
        });
      } catch (err) {
        console.error('WakeLock失败:', err);
      }
    }

    // 播放和暂停“考试须知”音频
    const audioExam = new Audio('audio/ksxz.mp3');
    const audioSubmit = new Audio('audio/tqjj.mp3');
    function togglePlay() {
      if (audioExam.paused) {
        audioExam.currentTime = 0;
        audioExam.play();
        el("btBofang").innerText = '暂停';
      } else {
        audioExam.pause();
        el("btBofang").innerText = '播放';
      }
    }
    audioExam.addEventListener('ended', () => el("btBofang").innerText = '播放');

    // 播放“提前交卷”音频
    function playSubmit() {
      exitFullscreen();   // 退出全屏
      audioSubmit.currentTime = 0;
      audioSubmit.play();
    }

    // 退出全屏
    function exitFullscreen() {
      const exit =
        document.exitFullscreen ||
        document.webkitExitFullscreen ||
        document.mozCancelFullScreen ||
        document.msExitFullscreen;

      if (exit) {
        exit.call(document);
      }
    }

    // 联想输入：关键词建议显示
    const inputK = el("inputKemu"), sug = el("suggestions");
    inputK.addEventListener('input', handleInput);
    inputK.addEventListener('click', handleInput);
    document.addEventListener('click', e => {
      if (!inputK.contains(e.target)) sug.style.display = 'none';
    });

    // 处理输入并过滤匹配建议
    function handleInput() {
      const q = inputK.value.trim().toLowerCase();
      const matched = suggestions.filter(s => s.toLowerCase().includes(q));
      renderSuggestions(matched);
    }

    // 渲染建议列表
    function renderSuggestions(list) {
      sug.innerHTML = '';
      if (!list.length) { sug.style.display = 'none'; return; }
      list.forEach(s => {
        const li = document.createElement('li');
        li.textContent = s;
        li.onclick = () => { inputK.value = s; sug.style.display = 'none'; };
        sug.appendChild(li);
      });
      sug.style.display = 'block';
    }

    // 初始化科目页数考试时间展示
    function updateDisplay() {
      el("divYeshu").innerText = el("inputYeshu").value;
      el("divChangci").innerText = el("inputChangci").value;
    }
  </script>
</body>

</html>

<!-- 
2.0 完整优化
1.8 使用API时间,后台更新时间,模态框
1.7 输入框科目联想;
1.6 添加提交语音;
1.5 根据当前时间自动切换场次,添加帮助,优化全屏功能;
1.4 添加考试须知播放;
1.3 实现显示字体放大缩小;
1.2 添加换场和全屏功能;
1.1 实现输入框, 通过输入框修改科目等内容;
1.0 实现时间和科目显示; 
-->